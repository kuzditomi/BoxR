var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},BoxR;(function(n){var t=!1,r,i,u,f,e;r=function(){function n(n,t,i){this.active=!1,this.ctx=n,this.x=t,this.y=i}return n.prototype.Draw=function(){},n.prototype.Click=function(){return new i(!1,0)},n}(),n.Drawable=r,i=function(){function n(n,t){this.EdgeActivated=n,this.SquereActivated=t}return n}(),n.ClickResponse=i,u=function(n){function t(t,i,r,u,f,e){n.call(this,t,i,r),this.width=u,this.height=f,this.isHorizontal=e,this.squeres=[],this.mouseover=!1}return __extends(t,n),t.prototype.Draw=function(){this.ctx.strokeStyle="black",this.ctx.fillStyle=this.active?"darkslateblue":this.mouseover?"rgb(27,161,226)":"slateblue",this.ctx.beginPath(),this.isHorizontal?(this.ctx.moveTo(this.x+this.width/6,this.y),this.ctx.lineTo(this.x+this.width*5/6,this.y),this.ctx.lineTo(this.x+this.width,this.y+this.height/2),this.ctx.lineTo(this.x+this.width*5/6,this.y+this.height),this.ctx.lineTo(this.x+this.width/6,this.y+this.height),this.ctx.lineTo(this.x,this.y+this.height/2)):(this.ctx.moveTo(this.x+this.width/2,this.y),this.ctx.lineTo(this.x+this.width,this.y+this.height/6),this.ctx.lineTo(this.x+this.width,this.y+this.height*5/6),this.ctx.lineTo(this.x+this.width/2,this.y+this.height),this.ctx.lineTo(this.x,this.y+this.height*5/6),this.ctx.lineTo(this.x,this.y+this.height/6)),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath()},t.prototype.MouseOver=function(n,t){this.active||(n>=this.x&&n<=this.x+this.width&&t>=this.y&&t<=this.y+this.height?(this.mouseover=!0,this.Draw()):this.mouseover&&(this.mouseover=!1,this.Draw()),this.ctx.stroke())},t.prototype.AddSquere=function(n){this.squeres.push(n)},t.prototype.Click=function(n,t){return this.active?new i(!1,0):n>=this.x&&n<=this.x+this.width&&t>=this.y&&t<=this.y+this.height?new i(!0,this.Activate()):new i(!1,0)},t.prototype.Activate=function(){this.active=!0;var n=0;return this.squeres.forEach(function(t){t.EdgeChecked()&&n++}),n},t}(r),n.Edge=u,f=function(n){function i(t,i,r,u){n.call(this,t,i,r),this.width=u,this.animated=!1,this.edges=[]}return __extends(i,n),i.prototype.EdgeChecked=function(){return this.EdgesChecked()==4?(this.active=!0,this.color=t?"27,161,226,":"290,20,0,",!0):!1},i.prototype.EdgesChecked=function(){for(var t=0,n=0;n<this.edges.length;n++)t+=this.edges[n].active?1:0;return t},i.prototype.Draw=function(){if(this.active)if(this.animated)this.ctx.fillStyle="rgba("+this.color+"1)",this.ctx.strokeStyle="black",this.ctx.beginPath(),this.ctx.rect(this.x,this.y,this.width,this.width),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke();else{var i=120,t=0,n=this,r=setInterval(function(){n.ctx.fillStyle="rgba("+n.color+t/i+")",n.ctx.strokeStyle="black",n.ctx.beginPath(),n.ctx.rect(n.x,n.y,n.width,n.width),n.ctx.closePath(),n.ctx.fill(),n.ctx.stroke(),t++,t===i&&clearInterval(r)},30);this.animated=!0}},i}(r),n.Squere=f,e=function(){function n(n){this.finished=!1,this.ctx=n.getContext("2d"),this.LeftOffset=n.offsetLeft,this.TopOffset=n.getBoundingClientRect().top,this.Width=n.clientWidth}return n.prototype.Init=function(n,i){var r,h,y,e,s;this.n=n,this.Clear(),this.selfScore=0,this.opponentScore=0,this.UpdateScore(),this.edges=[],this.squares=[],i?$("#blueturn").animate({width:"120px",marginLeft:"0px"}):$("#redturn").animate({width:"120px",marginLeft:"0px"});var l=7,o=this.Width/(n*l+(n+1)+2),a=[o,2*o],v=[2*o,o],c=l*o,p=[c,o],w=[o,c];for(r=0;r<2*n+1;r++)for(this.edges[r]=[],this.squares[r/2-1]=[],h=r%2,y=h==0?n:n+1,e=0;e<y;e++)this.edges[r][e]=new u(this.ctx,v[h]+e*(c+o),a[h]+Math.floor(r/2)*(c+o),p[h],w[h],h==0),h==0&&r>0&&(s=new f(this.ctx,v[0]+e*(o+c)+o/2,a[1]+(r-2)/2*(c+o)+o/2,c-o),this.squares[r/2-1][e]=s,this.edges[r][e].AddSquere(s),this.edges[r-1][e+1].AddSquere(s),this.edges[r-2][e].AddSquere(s),this.edges[r-1][e].AddSquere(s),s.edges.push(this.edges[r][e]),s.edges.push(this.edges[r-1][e+1]),s.edges.push(this.edges[r-2][e]),s.edges.push(this.edges[r-1][e]));t=i,this.selfScore=0,this.opponentScore=0},n.prototype.Draw=function(){this.Clear(),this.edges.forEach(function(n){n.forEach(function(n){n.Draw()})}),this.squares.forEach(function(n){n.forEach(function(n){n.Draw()})})},n.prototype.Clear=function(){this.ctx.clearRect(0,0,this.ctx.canvas.clientWidth,this.ctx.canvas.clientWidth)},n.prototype.Click=function(n){var r,u,i;t&&(r=n.pageX-this.LeftOffset,u=n.pageY-this.TopOffset,n.pageX&&n.pageY||(r=n.x-this.LeftOffset,u=n.y-this.TopOffset),i=this,this.edges.forEach(function(n){n.forEach(function(n){var t=n.Click(r,u);if(t.EdgeActivated){i.selfScore+=t.SquereActivated,t.SquereActivated==0?i.NextRound():i.UpdateScore(),i.Draw();return}})}))},n.prototype.MouseMove=function(n){if(t){var i=n.clientX-this.LeftOffset,r=n.clientY-this.TopOffset;this.edges.forEach(function(n){n.forEach(function(n){n.MouseOver(i,r)})}),this.Draw()}},n.prototype.EdgeClickFromServer=function(n){var t=this,i;return n.active?!1:(i=n.Activate(),t.opponentScore+=i,i==0?(t.Draw(),!1):(t.UpdateScore(),t.Draw(),!0))},n.prototype.UpdateScore=function(){var i=document.getElementById("selfscore"),n,t;i.textContent=this.selfScore.toString(),n=document.getElementById("opponentscore"),n.textContent=this.opponentScore.toString(),this.selfScore+this.opponentScore==this.n*this.n&&(this.finished=!0,t=document.getElementById("blanket"),t.style.display="table",this.selfScore>this.opponentScore?document.getElementById("winPopup").style.display="block":document.getElementById("losePopup").style.display="block")},n.prototype.NextRound=function(){t^=!0,t?($("#blueturn").animate({width:"120px",marginLeft:"0px"}),$("#redturn").animate({width:"0px",marginLeft:"0px"})):($("#redturn").animate({width:"120px",marginLeft:"0px"}),$("#blueturn").animate({width:"0px",marginLeft:"0px"}),this.MachineClick())},n.prototype.MachineClick=function(){var n=this;setTimeout(function(){var t=n.FourthClick()||n.CleverClick(0),i=n.EdgeClickFromServer(t);i?n.MachineClick():n.NextRound()},1500)},n.prototype.CleverClick=function(n){for(var e=!1,i=[],r,f,u,t=0;t<this.edges.length;t++)for(r=0;r<this.edges[t].length;r++)this.edges[t][r].active||i.push(this.edges[t][r]);while(!e&&i.length>0){if(f=Math.floor(Math.random()*i.length),u=i[f],u.squeres[0].EdgesChecked()<=n&&(u.squeres.length==1||u.squeres[1].EdgesChecked()<=n))return u;i.splice(f,1)}if(!e)return this.CleverClick(n+1)},n.prototype.FourthClick=function(){for(var r=!1,f,u,t,i,n=0;n<this.squares.length&&!r;n++)for(u=0;u<this.squares[n].length&&!r;u++)if(t=this.squares[n][u],t.EdgesChecked()==3)for(i=0;i<t.edges.length;i++)t.edges[i].active||(f=t.edges[i],r=!0);return r?f:null},n.prototype.Clone=function(){return JSON.parse(JSON.stringify(this,function(n,t){return n=="canvas"||n=="squeres"||n=="children"?2:t}))},n.prototype.minimax=function(n,t,i){var e,u,f,r,o,h,s;if(console.log("minimax start, depth: "+t),n.n==n.opponentScore+n.selfScore||t==0)return console.log("return: opponent:"+n.opponentScore+" self:"+n.selfScore+" value:"+this.valueOf(n)),this.valueOf(n);for(e=-this.n*this.n-1,u=[],r=0;r<n.edges.length;r++)for(f=0;f<n.edges[r].length;f++)n.edges[r][f]||u.push({i:r,j:f});for(r=0;r<u.length;r++)o=JSON.parse(JSON.stringify(n)),console.log("click: "+u[r].i+":"+u[r].j),this.EmulateClick(o,u[r]),h={},s=this.minimax(o,t-1,h),s>e&&(e=s,i.i=u[r].i,i.j=u[r].j);return e},n.prototype.valueOf=function(n){return n.opponentScore-n.selfScore},n.prototype.getGameState=function(){var i={},n,r;for(i.edges=[],n=0;n<this.edges.length;n++)for(i.edges[n]=[],r=0;r<this.edges[n].length;r++)i.edges[n][r]=this.edges[n][r].active;for(i.squares=[],n=0;n<this.squares.length;n++)for(i.squares[n]=[],r=0;r<this.squares[n].length;r++)i.squares[n][r]=this.squares[n][r].EdgesChecked();return i.opponentScore=this.opponentScore,i.selfScore=this.selfScore,i.n=this.n,i.turn=t,i},n.prototype.EmulateClick=function(n,t){n.edges[t.i][t.j]=!0,t.i%2==0?(t.i*2<t.n&&(n.squares[2*t.i][t.j]+=1,n.squares[2*t.i][t.j]==3&&(n.selfScore=n.turn?n.selfScore+1:n.selfScore,n.opponentScore=n.turn?n.opponentScore:n.opponentScore+1)),t.i*2<t.n&&(n.squares[2*t.i+2][t.j]+=1,n.squares[2*t.i+2][t.j]==3&&(n.selfScore=n.turn?n.selfScore+1:n.selfScore,n.opponentScore=n.turn?n.opponentScore:n.opponentScore+1))):(t.i>0&&t.j>0&&n.squares[(t.i-1)/2][t.j-1]==3&&(n.squares[(t.i-1)/2][t.j-1]+=1,n.selfScore=n.turn?n.selfScore+1:n.selfScore,n.opponentScore=n.turn?n.opponentScore:n.opponentScore+1),t.i>0&&n.squares[(t.i-1)/2][t.j]==4&&(n.squares[(t.i-1)/2][t.j]+=1,n.selfScore=n.turn?n.selfScore+1:n.selfScore,n.opponentScore=n.turn?n.opponentScore:n.opponentScore+1))},n}(),n.Game=e})(BoxR||(BoxR={}))