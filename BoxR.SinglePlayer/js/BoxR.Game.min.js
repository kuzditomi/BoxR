var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},BoxR;(function(n){"use strict";var h="rgb(27,161,226)",c="rgb(242,20,0)",e="rgb(256,256,256)",o="rgb(27,161,226)",t=!1,r=function(){function n(n,t,i){this.active=!1,this.ctx=n,this.x=t,this.y=i}return n.prototype.Draw=function(){},n.prototype.Click=function(){return new i(!1,0)},n}(),i,u,f,s;n.Drawable=r,i=function(){function n(n,t){this.EdgeActivated=n,this.SquereActivated=t}return n}(),n.ClickResponse=i,u=function(n){function t(t,i,r,u,f,e){n.call(this,t,i,r),this.width=u,this.height=f,this.isHorizontal=e,this.squeres=[],this.mouseover=!1}return __extends(t,n),t.prototype.Draw=function(){this.ctx.strokeStyle="black",this.ctx.fillStyle=this.active?o:this.mouseover?o:e,this.ctx.beginPath(),this.isHorizontal?(this.ctx.moveTo(this.x+this.width/6,this.y),this.ctx.lineTo(this.x+this.width*5/6,this.y),this.ctx.lineTo(this.x+this.width,this.y+this.height/2),this.ctx.lineTo(this.x+this.width*5/6,this.y+this.height),this.ctx.lineTo(this.x+this.width/6,this.y+this.height),this.ctx.lineTo(this.x,this.y+this.height/2)):(this.ctx.moveTo(this.x+this.width/2,this.y),this.ctx.lineTo(this.x+this.width,this.y+this.height/6),this.ctx.lineTo(this.x+this.width,this.y+this.height*5/6),this.ctx.lineTo(this.x+this.width/2,this.y+this.height),this.ctx.lineTo(this.x,this.y+this.height*5/6),this.ctx.lineTo(this.x,this.y+this.height/6)),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath()},t.prototype.MouseOver=function(n,t){this.active||(n>=this.x&&n<=this.x+this.width&&t>=this.y&&t<=this.y+this.height?(this.mouseover=!0,this.Draw()):this.mouseover&&(this.mouseover=!1,this.Draw()),this.ctx.stroke())},t.prototype.AddSquere=function(n){this.squeres.push(n)},t.prototype.Click=function(n,t){return this.active?new i(!1,0):n>=this.x&&n<=this.x+this.width&&t>=this.y&&t<=this.y+this.height?new i(!0,this.Activate()):new i(!1,0)},t.prototype.Activate=function(){this.active=!0;var n=0;return this.squeres.forEach(function(t){t.EdgeChecked()&&n++}),n},t}(r),n.Edge=u,f=function(n){function i(t,i,r,u){n.call(this,t,i,r),this.width=u,this.animated=!1,this.edges=[]}return __extends(i,n),i.prototype.EdgeChecked=function(){return this.EdgesChecked()==4?(this.active=!0,this.color=t?h:c,!0):!1},i.prototype.EdgesChecked=function(){for(var t=0,n=0;n<this.edges.length;n++)t+=this.edges[n].active?1:0;return t},i.prototype.Draw=function(){var r;if(this.active)if(this.animated)this.ctx.fillStyle=this.color,this.ctx.strokeStyle="black",this.ctx.beginPath(),this.ctx.rect(this.x,this.y,this.width,this.width),this.ctx.closePath(),this.ctx.fill();else{var t=0,i=0,n=this;n.ctx.fillStyle=n.color,n.ctx.strokeStyle="black",n.ctx.beginPath(),n.ctx.rect(n.x,n.y,n.width,n.width),n.ctx.closePath(),n.ctx.fill(),n.ctx.stroke(),t++,r=setInterval(function(){i==0?(n.ctx.strokeStyle="black",n.ctx.beginPath(),n.ctx.rect(n.x-1,n.y-1,n.width+2,n.width+2),n.ctx.closePath(),n.ctx.fillStyle=e,n.ctx.fill(),n.ctx.beginPath(),n.ctx.rect(n.x+t,n.y,n.width-t*2,n.width),n.ctx.closePath(),n.ctx.fillStyle=n.color,n.ctx.fill(),t+=2,t>=n.width/2&&(i=1)):(n.ctx.beginPath(),n.ctx.rect(n.x+t,n.y,n.width-t*2,n.width),n.ctx.closePath(),n.ctx.fillStyle=n.color,n.ctx.fill(),t-=3,t<=0&&clearInterval(r))},10),this.animated=!0}},i}(r),n.Squere=f,s=function(){function n(n){this.finished=!1,this.ctx=n.getContext("2d"),this.LeftOffset=n.offsetLeft,this.TopOffset=n.getBoundingClientRect().top,this.Width=n.clientWidth}return n.prototype.Init=function(n,i){var r,h,y,e,s;this.n=n,this.Clear(),this.selfScore=0,this.opponentScore=0,this.UpdateScore(),this.edges=[],this.squares=[],i?$("#blueturn").animate({width:"120px",marginLeft:"0px"}):$("#redturn").animate({width:"120px",marginLeft:"0px"});var l=7,o=this.Width/(n*l+(n+1)+2),a=[o,2*o],v=[2*o,o],c=l*o,p=[c,o],w=[o,c];for(r=0;r<2*n+1;r++)for(this.edges[r]=[],this.squares[r/2-1]=[],h=r%2,y=h==0?n:n+1,e=0;e<y;e++)this.edges[r][e]=new u(this.ctx,v[h]+e*(c+o),a[h]+Math.floor(r/2)*(c+o),p[h],w[h],h==0),h==0&&r>0&&(s=new f(this.ctx,v[0]+e*(o+c)+o/2,a[1]+(r-2)/2*(c+o)+o/2,c-o),this.squares[r/2-1][e]=s,this.edges[r][e].AddSquere(s),this.edges[r-1][e+1].AddSquere(s),this.edges[r-2][e].AddSquere(s),this.edges[r-1][e].AddSquere(s),s.edges.push(this.edges[r][e]),s.edges.push(this.edges[r-1][e+1]),s.edges.push(this.edges[r-2][e]),s.edges.push(this.edges[r-1][e]));t=i,this.selfScore=0,this.opponentScore=0},n.prototype.Draw=function(){this.Clear(),this.edges.forEach(function(n){n.forEach(function(n){n.Draw()})}),this.squares.forEach(function(n){n.forEach(function(n){n.Draw()})})},n.prototype.Clear=function(){this.ctx.clearRect(0,0,this.ctx.canvas.clientWidth,this.ctx.canvas.clientWidth)},n.prototype.Click=function(n){var r,u,i;t&&(r=n.pageX-this.LeftOffset,u=n.pageY-this.TopOffset,n.pageX&&n.pageY||(r=n.x-this.LeftOffset,u=n.y-this.TopOffset),i=this,this.edges.forEach(function(n){n.forEach(function(n){var t=n.Click(r,u);if(t.EdgeActivated){i.selfScore+=t.SquereActivated,t.SquereActivated==0?i.NextRound():i.UpdateScore(),i.Draw();return}})}))},n.prototype.MouseMove=function(n){if(t){var i=n.clientX-this.LeftOffset,r=n.clientY-this.TopOffset;this.edges.forEach(function(n){n.forEach(function(n){n.MouseOver(i,r)})}),this.Draw()}},n.prototype.EdgeClickFromServer=function(n){var t=this,i;return n.active?!1:(i=n.Activate(),t.opponentScore+=i,t.UpdateScore(),t.Draw(),i==0)?!1:!0},n.prototype.UpdateScore=function(){var i=document.getElementById("selfscore"),n,t;i.textContent=this.selfScore.toString(),n=document.getElementById("opponentscore"),n.textContent=this.opponentScore.toString(),this.selfScore+this.opponentScore==this.n*this.n&&(this.finished=!0,t=document.getElementById("blanket"),t.style.display="table",this.selfScore>this.opponentScore?document.getElementById("winPopup").style.display="block":document.getElementById("losePopup").style.display="block")},n.prototype.NextRound=function(){t^=!0,t||this.MachineClick()},n.prototype.MachineClick=function(){var n=this,n=this;setTimeout(function(){var i=n.FourthClick(),r=n.CleverClick(0)||n.CleverClick(1),u,t;r?i?(n.EdgeClickFromServer(i),n.MachineClick()):(n.EdgeClickFromServer(r),n.NextRound()):(u=n.getGameState(),t=new Worker("js/BoxR.MiniMax.js"),t.postMessage({gameState:u,depth:6}),t.onmessage=function(t){var i=n.EdgeClickFromServer(n.edges[t.data.nextClick.i][t.data.nextClick.j]);i?n.MachineClick():n.NextRound()})},1e3)},n.prototype.CleverClick=function(n){var f,t,i,r,e,u;if(n==2)return null;for(f=!1,t=[],i=0;i<this.edges.length;i++)for(r=0;r<this.edges[i].length;r++)this.edges[i][r].active||t.push(this.edges[i][r]);while(!f&&t.length>0){if(e=Math.floor(Math.random()*t.length),u=t[e],u.squeres[0].EdgesChecked()<=n&&(u.squeres.length==1||u.squeres[1].EdgesChecked()<=n))return u;t.splice(e,1)}if(!f)return null},n.prototype.FourthClick=function(){for(var r=!1,f,u,t,i,n=0;n<this.squares.length&&!r;n++)for(u=0;u<this.squares[n].length&&!r;u++)if(t=this.squares[n][u],t.EdgesChecked()==3)for(i=0;i<t.edges.length;i++)t.edges[i].active||(f=t.edges[i],r=!0);return r?f:null},n.prototype.getGameState=function(){var i={},n,r;for(i.edges=[],n=0;n<this.edges.length;n++)for(i.edges[n]=[],r=0;r<this.edges[n].length;r++)i.edges[n][r]=this.edges[n][r].active;for(i.squares=[],n=0;n<this.squares.length;n++)for(i.squares[n]=[],r=0;r<this.squares[n].length;r++)i.squares[n][r]=this.squares[n][r].EdgesChecked();return i.opponentScore=this.opponentScore,i.selfScore=this.selfScore,i.n=this.n,i.turn=t,i},n}(),n.Game=s})(BoxR||(BoxR={}))