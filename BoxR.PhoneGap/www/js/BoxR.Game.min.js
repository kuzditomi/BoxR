var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},BoxR;(function(n){"use strict";var s="rgb(27,161,226)",h="rgb(242,20,0)",c="rgb(256,256,256)",t,r,u,f,i,e,o;n.activeColor="rgb(27,161,226)",t=!1,r=function(){function n(n,t,i){this.active=!1,this.ctx=n,this.x=t,this.y=i}return n.prototype.Draw=function(){},n.prototype.Click=function(){return new i(!1,0)},n}(),n.Drawable=r,u=function(t){function r(n,i,r,u,f,e){t.call(this,n,Math.floor(i),Math.floor(r)),this.width=Math.floor(u),this.height=Math.floor(f),this.isHorizontal=e,this.Squeres=[],this.mouseover=!1}return __extends(r,t),r.prototype.Draw=function(){this.ctx.strokeStyle="black",this.ctx.fillStyle=this.active?n.activeColor:this.mouseover?n.activeColor:c,this.ctx.beginPath(),this.isHorizontal?(this.ctx.moveTo(Math.floor(this.x+this.width/6),this.y),this.ctx.lineTo(Math.floor(this.x+this.width*5/6),this.y),this.ctx.lineTo(this.x+this.width,Math.floor(this.y+this.height/2)),this.ctx.lineTo(Math.floor(this.x+this.width*5/6),this.y+this.height),this.ctx.lineTo(Math.floor(this.x+this.width/6),this.y+this.height),this.ctx.lineTo(this.x,Math.floor(this.y+this.height/2))):(this.ctx.moveTo(this.x+this.width/2,this.y),this.ctx.lineTo(this.x+this.width,this.y+this.height/6),this.ctx.lineTo(this.x+this.width,this.y+this.height*5/6),this.ctx.lineTo(this.x+this.width/2,this.y+this.height),this.ctx.lineTo(this.x,this.y+this.height*5/6),this.ctx.lineTo(this.x,this.y+this.height/6)),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()},r.prototype.MouseOver=function(n,t){this.active||(n>=this.x&&n<=this.x+this.width&&t>=this.y&&t<=this.y+this.height?(this.mouseover=!0,this.Draw()):this.mouseover&&(this.mouseover=!1,this.Draw()),this.ctx.stroke())},r.prototype.AddSquere=function(n){this.Squeres.push(n)},r.prototype.Click=function(n,t){return this.active?new i(!1,0):n>=this.x+(this.isHorizontal?0:-10)&&n<=this.x+this.width+(this.isHorizontal?0:10)&&t>=this.y+(this.isHorizontal?-10:0)&&t<=this.y+this.height+(this.isHorizontal?10:0)?new i(!0,this.Activate()):new i(!1,0)},r.prototype.Activate=function(){this.active=!0;var n=0;return this.Squeres.forEach(function(t){t.EdgeChecked()&&n++}),n},r}(r),n.Edge=u,f=function(n){function i(t,i,r,u){n.call(this,t,i,r),this.width=u,this.animated=!1,this.edges=[]}return __extends(i,n),i.prototype.EdgeChecked=function(){return this.EdgesChecked()==4?(this.active=!0,this.color=t?s:h,!0):!1},i.prototype.EdgesChecked=function(){for(var t=0,n=0;n<this.edges.length;n++)t+=this.edges[n].active?1:0;return t},i.prototype.Draw=function(){var r;if(this.active)if(this.animated)this.ctx.fillStyle=this.color,this.ctx.strokeStyle="black",this.ctx.beginPath(),this.ctx.rect(this.x,this.y,this.width,this.width),this.ctx.closePath(),this.ctx.fill();else{var t=0,i=0,n=this;n.ctx.fillStyle=n.color,n.ctx.strokeStyle="black",n.ctx.beginPath(),n.ctx.rect(n.x,n.y,n.width,n.width),n.ctx.closePath(),n.ctx.fill(),n.ctx.stroke(),t++,r=setInterval(function(){i==0?(n.ctx.clearRect(n.x-1,n.y-1,n.width+2,n.width+2),n.ctx.beginPath(),n.ctx.rect(n.x+t,n.y,n.width-t*2,n.width),n.ctx.closePath(),n.ctx.fillStyle=n.color,n.ctx.fill(),t+=2,t>=n.width/2&&(i=1)):(n.ctx.beginPath(),n.ctx.rect(n.x+t,n.y,n.width-t*2,n.width),n.ctx.closePath(),n.ctx.fillStyle=n.color,n.ctx.fill(),t-=3,t<=0&&clearInterval(r))},10),this.animated=!0}},i}(r),n.Squere=f,i=function(){function n(n,t){this.EdgeActivated=n,this.SquereActivated=t}return n}(),n.ClickResponse=i,e=function(){function n(n,t){this.x=n,this.y=t}return n}(),n.Coordinate=e,o=function(){function i(n,t,i){typeof t=="undefined"&&(t=!1),typeof i=="undefined"&&(i=!1),this.ctx=n.getContext("2d"),this.canvas=n,this.Width=n.clientWidth,this.IsSinglePlayer=t,this._noWebWorker=i}return i.prototype.Init=function(i,r){var e,c,p,o,h;this.n=i,this.Clear(),this.Edges=[],this.Squares=[];var a=7,s=Math.floor(this.Width/(i*a+(i+1)+2)),v=[s,2*s],y=[2*s,s],l=a*s,w=[l,s],b=[s,l];for(e=0;e<2*i+1;e++)for(this.Edges[e]=[],this.Squares[e/2-1]=[],c=e%2,p=c==0?i:i+1,o=0;o<p;o++)this.Edges[e][o]=new u(this.ctx,y[c]+o*(l+s),v[c]+Math.floor(e/2)*(l+s),w[c],b[c],c==0),c==0&&e>0&&(h=new f(this.ctx,y[0]+o*(s+l)+s/2,v[1]+(e-2)/2*(l+s)+s/2,l-s),this.Squares[e/2-1][o]=h,this.Edges[e][o].AddSquere(h),this.Edges[e-1][o+1].AddSquere(h),this.Edges[e-2][o].AddSquere(h),this.Edges[e-1][o].AddSquere(h),h.edges.push(this.Edges[e][o]),h.edges.push(this.Edges[e-1][o+1]),h.edges.push(this.Edges[e-2][o]),h.edges.push(this.Edges[e-1][o]));t=r,this.selfScore=0,this.opponentScore=0,this.IsSinglePlayer||n.Manager.Server.UpdateRound(t)},i.prototype.Resize=function(n){var i,u,a,f,o,s;this.canvas.width=n,this.canvas.height=n,this.Width=n;var e=this.n,h=7,t=Math.floor(this.Width/(e*h+(e+1)+2)),c=[t,2*t],l=[2*t,t],r=h*t,v=[r,t],y=[t,r];for(i=0;i<2*e+1;i++)for(u=i%2,a=u==0?e:e+1,f=0;f<a;f++)o=this.Edges[i][f],o.x=l[u]+f*(r+t),o.y=c[u]+Math.floor(i/2)*(r+t),o.width=v[u],o.height=y[u],u==0&&i>0&&(s=this.Squares[i/2-1][f],s.x=l[0]+f*(t+r)+t/2,s.y=c[1]+(i-2)/2*(r+t)+t/2,s.width=r-t)},i.prototype.Draw=function(){this.Clear(),this.ctx.save(),this.ctx.translate(.5,.5),this.Edges.forEach(function(n){n.forEach(function(n){n.Draw()})}),this.Squares.forEach(function(n){n.forEach(function(n){n.Draw()})}),this.ctx.restore()},i.prototype.Clear=function(){this.ctx.clearRect(0,0,this.ctx.canvas.clientWidth,this.ctx.canvas.clientWidth)},i.prototype.Click=function(i){var e=this.canvas.getBoundingClientRect().left,o=this.canvas.getBoundingClientRect().top,u,f,r;t&&(u=i.pageX-e,f=i.pageY-o,i.pageX&&i.pageY||(u=i.x-e,f=i.y-o),r=this,this.Edges.forEach(function(t,i){t.forEach(function(t,e){var o=t.Click(u,f);if(o.EdgeActivated){r.IsSinglePlayer||n.Manager.Hub.server.edgeClicked(i,e),r.selfScore+=o.SquereActivated,o.SquereActivated==0?r.NextRound():r.UpdateScore(),r.Draw();return}})}))},i.prototype.MouseMove=function(n){var u=this.canvas.getBoundingClientRect().left,f=this.canvas.getBoundingClientRect().top,i,r;t&&(i=n.clientX-u,r=n.clientY-f,this.Edges.forEach(function(n){n.forEach(function(n){n.MouseOver(i,r)})}),this.Draw())},i.prototype.EdgeClickFromServerByCoordinate=function(n,t){if(!this.Edges[n][t].active){var i=this.Edges[n][t].Activate();this.opponentScore+=i,i==0?this.NextRound():this.UpdateScore(),this.Draw()}},i.prototype.EdgeClickFromServerByEdge=function(n){var t=this,i;return n&&!n.active?(i=n.Activate(),t.opponentScore+=i,i==0?(t.Draw(),!1):(t.UpdateScore(),t.Draw(),!(this.selfScore+this.opponentScore==this.n*this.n))):!1},i.prototype.UpdateScore=function(){if(n.Manager.Client.UpdateSelfScore(this.selfScore),n.Manager.Client.UpdateOpponentScore(this.opponentScore),this.selfScore+this.opponentScore==this.n*this.n){this.IsSinglePlayer||n.Manager.Hub.server.finishGame(),this.selfScore>this.opponentScore?n.Manager.Client.WinPopup():n.Manager.Client.LosePopup();return}},i.prototype.NextRound=function(){t^=!0,this.IsSinglePlayer?t||this.MachineClick():n.Manager.Server.UpdateRound(t)},i.prototype.MachineClick=function(){var n=this,n=this;setTimeout(function(){var i=n.FourthClick(),t=n.CleverClick(0)||n.CleverClick(1),u,r;t?i?(n.EdgeClickFromServerByEdge(i),n.MachineClick()):(n.EdgeClickFromServerByEdge(t),n.NextRound()):n._noWebWorker?(t=n.CleverClick(2)||n.CleverClick(3),i?(n.EdgeClickFromServerByEdge(i),n.MachineClick()):(n.EdgeClickFromServerByEdge(t),n.NextRound())):(u=n.getGameState(),r=new Worker("/js/BoxR.MiniMax.js"),r.postMessage({gameState:u,depth:6}),r.onmessage=function(t){var i=n.EdgeClickFromServerByEdge(n.Edges[t.data.nextClick.i][t.data.nextClick.j]);i?n.MachineClick():n.NextRound()})},1e3)},i.prototype.CleverClick=function(n){var f,t,i,r,e,u;if(n==2)return null;for(f=!1,t=[],i=0;i<this.Edges.length;i++)for(r=0;r<this.Edges[i].length;r++)this.Edges[i][r].active||t.push(this.Edges[i][r]);while(!f&&t.length>0){if(e=Math.floor(Math.random()*t.length),u=t[e],u.Squeres[0].EdgesChecked()<=n&&(u.Squeres.length==1||u.Squeres[1].EdgesChecked()<=n))return u;t.splice(e,1)}if(!f)return null},i.prototype.FourthClick=function(){for(var r=!1,f,u,t,i,n=0;n<this.Squares.length&&!r;n++)for(u=0;u<this.Squares[n].length&&!r;u++)if(t=this.Squares[n][u],t.EdgesChecked()==3)for(i=0;i<t.edges.length;i++)t.edges[i].active||(f=t.edges[i],r=!0);return r?f:null},i.prototype.getGameState=function(){var i={},n,r;for(i.edges=[],n=0;n<this.Edges.length;n++)for(i.edges[n]=[],r=0;r<this.Edges[n].length;r++)i.edges[n][r]=this.Edges[n][r].active;for(i.squares=[],n=0;n<this.Squares.length;n++)for(i.squares[n]=[],r=0;r<this.Squares[n].length;r++)i.squares[n][r]=this.Squares[n][r].EdgesChecked();return i.opponentScore=this.opponentScore,i.selfScore=this.selfScore,i.n=this.n,i.turn=t,i},i}(),n.Game=o})(BoxR||(BoxR={}))